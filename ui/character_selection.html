<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * { box-sizing: border-box; }

        :root {
            --bg-0: #020611;
            --bg-1: #071427;
            --bg-2: #0a213b;
            --line: rgba(103, 220, 255, 0.42);
            --line-soft: rgba(194, 240, 255, 0.16);
            --text: #ecf9ff;
            --text-soft: #8eb4cc;
            --accent: #00c3ff;
            --accent-2: #5effdc;
            --danger: #ff657e;
            --ok: #6effb7;
            --warn: #ffd07d;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            position: relative;
            font-family: "Bahnschrift", "Segoe UI", "Consolas", monospace;
            color: var(--text);
            isolation: isolate;
            background:
                radial-gradient(circle at 19% 16%, rgba(0, 180, 255, 0.28), transparent 34%),
                radial-gradient(circle at 82% 22%, rgba(72, 255, 227, 0.1), transparent 33%),
                radial-gradient(circle at 56% 84%, rgba(0, 154, 255, 0.13), transparent 42%),
                linear-gradient(162deg, var(--bg-0), var(--bg-1) 56%, #021020);
        }

        body::before {
            content: "";
            position: absolute;
            inset: -30%;
            pointer-events: none;
            opacity: 0.94;
            background:
                radial-gradient(1px 1px at 12% 18%, rgba(255, 255, 255, 0.82), transparent 50%),
                radial-gradient(1px 1px at 28% 72%, rgba(136, 228, 255, 0.72), transparent 50%),
                radial-gradient(1px 1px at 52% 34%, rgba(255, 255, 255, 0.7), transparent 50%),
                radial-gradient(1px 1px at 76% 62%, rgba(98, 210, 255, 0.66), transparent 50%),
                radial-gradient(1px 1px at 88% 24%, rgba(171, 233, 255, 0.74), transparent 50%);
            animation: starsDrift 42s linear infinite;
        }

        body::after {
            content: "";
            position: absolute;
            inset: -12%;
            pointer-events: none;
            opacity: 0.22;
            transform: perspective(1000px) rotateX(67deg) translateY(24%);
            background:
                repeating-linear-gradient(to right, rgba(255, 255, 255, 0.03) 0, rgba(255, 255, 255, 0.03) 1px, transparent 1px, transparent 74px),
                repeating-linear-gradient(to bottom, rgba(255, 255, 255, 0.024) 0, rgba(255, 255, 255, 0.024) 1px, transparent 1px, transparent 74px);
            animation: gridDrift 30s linear infinite;
        }

        .flow-depth {
            position: absolute;
            inset: -24%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.76;
            transform-origin: 50% 100%;
            transform: perspective(1400px) rotateX(73deg) translateY(36%) scale(1.22);
            background:
                radial-gradient(128% 76% at 50% 116%, rgba(0, 159, 247, 0.56), transparent 64%),
                conic-gradient(from 170deg at 50% 84%, rgba(0, 199, 255, 0.28), rgba(97, 255, 232, 0.14), rgba(0, 176, 255, 0.24), rgba(0, 199, 255, 0.28));
            filter: blur(20px) saturate(1.08);
            animation: flowPerspective 18s ease-in-out infinite alternate;
        }

        .flow-depth::before {
            content: "";
            position: absolute;
            inset: -14%;
            background:
                linear-gradient(98deg, transparent 10%, rgba(143, 232, 255, 0.12) 35%, transparent 56%),
                linear-gradient(118deg, transparent 26%, rgba(96, 255, 224, 0.1) 52%, transparent 78%);
            filter: blur(16px);
            animation: flowSweep 9.8s ease-in-out infinite;
        }

        .shell {
            position: relative;
            z-index: 1;
            width: min(96vw, 1240px);
            height: min(92vh, 760px);
            margin: 3vh auto;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
            animation: riseIn 860ms cubic-bezier(0.2, 0.88, 0.2, 1);
        }

        .topbar {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border: 1px solid var(--line);
            background:
                linear-gradient(150deg, rgba(8, 21, 38, 0.96), rgba(6, 12, 24, 0.92)),
                linear-gradient(90deg, rgba(0, 197, 255, 0.09), transparent 46%);
            box-shadow: 0 16px 36px rgba(0, 0, 0, 0.44), 0 0 28px rgba(0, 195, 255, 0.12);
            padding: 12px 18px;
            overflow: hidden;
        }

        .topbar::after {
            content: "";
            position: absolute;
            inset: 8px;
            border: 1px solid var(--line-soft);
            pointer-events: none;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-mark {
            width: 44px;
            height: 44px;
            border-radius: 11px;
            border: 1px solid rgba(121, 221, 255, 0.55);
            display: grid;
            place-items: center;
            background: linear-gradient(160deg, rgba(11, 30, 52, 0.9), rgba(9, 16, 30, 0.74));
            box-shadow: inset 0 0 18px rgba(0, 191, 255, 0.2), 0 0 18px rgba(0, 191, 255, 0.12);
        }

        .brand-mark svg {
            width: 22px;
            height: 22px;
            stroke: #9ee8ff;
            stroke-width: 1.8;
            fill: none;
            filter: drop-shadow(0 0 6px rgba(0, 193, 255, 0.5));
        }

        .brand-title {
            font-size: clamp(24px, 3.1vw, 34px);
            letter-spacing: 2px;
            line-height: 1;
            font-weight: 700;
            text-transform: uppercase;
            color: #f5fcff;
            text-shadow: 0 0 18px rgba(0, 195, 255, 0.34);
        }

        .brand-sub {
            margin-top: 3px;
            font-size: 11px;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: #7fd9ff;
            opacity: 0.9;
        }

        .account-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #97e6ff;
            padding: 8px 12px;
            border: 1px solid rgba(130, 226, 255, 0.35);
            background: rgba(2, 12, 26, 0.75);
        }

        .account-status i {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: var(--ok);
            box-shadow: 0 0 10px rgba(110, 255, 183, 0.75);
            animation: pulseDot 1.8s ease-in-out infinite;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(320px, 0.95fr) minmax(360px, 1.1fr);
            gap: 16px;
            min-height: 0;
        }

        .panel {
            position: relative;
            border: 1px solid var(--line);
            background:
                linear-gradient(152deg, rgba(7, 19, 34, 0.95), rgba(5, 12, 24, 0.9)),
                linear-gradient(92deg, rgba(0, 199, 255, 0.08), transparent 45%);
            box-shadow: 0 18px 42px rgba(0, 0, 0, 0.48), 0 0 32px rgba(0, 196, 255, 0.12);
            overflow: hidden;
        }

        .panel::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(118deg, transparent 0%, rgba(255, 255, 255, 0.08) 48%, transparent 70%);
            transform: translateX(-120%);
            animation: sweep 9s ease-in-out infinite;
            pointer-events: none;
        }

        .panel::after {
            content: "";
            position: absolute;
            inset: 10px;
            border: 1px solid var(--line-soft);
            pointer-events: none;
        }

        .panel-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 8px;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-size: 11px;
            color: #9adfff;
        }

        .slot-count {
            color: #d8f6ff;
            font-weight: 700;
        }

        .char-list {
            position: relative;
            z-index: 1;
            height: calc(100% - 46px);
            padding: 6px 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: auto;
        }

        .char-list::-webkit-scrollbar { width: 8px; }
        .char-list::-webkit-scrollbar-track { background: rgba(6, 18, 33, 0.6); }
        .char-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(0, 196, 255, 0.58), rgba(88, 255, 230, 0.72));
            border-radius: 999px;
        }

        .char-slot {
            border: 1px solid rgba(125, 220, 255, 0.24);
            background: linear-gradient(145deg, rgba(6, 15, 28, 0.9), rgba(6, 12, 22, 0.86));
            min-height: 78px;
            padding: 11px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 180ms ease, border-color 180ms ease, box-shadow 180ms ease, background 180ms ease;
        }

        .char-slot:hover {
            transform: translateY(-1px);
            border-color: rgba(139, 228, 255, 0.5);
            box-shadow: 0 8px 18px rgba(0, 184, 255, 0.18);
        }

        .char-slot.active {
            border-color: rgba(94, 224, 255, 0.9);
            background:
                linear-gradient(145deg, rgba(10, 35, 60, 0.88), rgba(8, 21, 39, 0.88)),
                linear-gradient(90deg, rgba(0, 197, 255, 0.17), transparent 50%);
            box-shadow: inset 0 0 20px rgba(0, 194, 255, 0.16), 0 0 24px rgba(0, 195, 255, 0.2);
        }

        .slot-icon {
            flex: 0 0 42px;
            width: 42px;
            height: 42px;
            border-radius: 11px;
            border: 1px solid rgba(125, 220, 255, 0.38);
            display: grid;
            place-items: center;
            background: rgba(4, 15, 27, 0.86);
        }

        .slot-icon svg {
            width: 22px;
            height: 22px;
            stroke: #9ee6ff;
            stroke-width: 1.7;
            fill: none;
        }

        .slot-main {
            flex: 1;
            min-width: 0;
        }

        .slot-name {
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #f0fbff;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slot-meta {
            margin-top: 3px;
            font-size: 11px;
            color: var(--text-soft);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .slot-empty {
            color: #87b8d4;
            font-size: 11px;
            letter-spacing: 1.2px;
            text-transform: uppercase;
        }

        .info-wrap {
            position: relative;
            z-index: 1;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 0;
        }

        .info-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 8px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-size: 11px;
            color: #9adfff;
        }

        .info-body {
            padding: 0 16px 16px;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 10px;
        }

        .note {
            border: 1px solid rgba(128, 220, 255, 0.25);
            background: rgba(4, 14, 27, 0.74);
            padding: 10px 11px;
            font-size: 11px;
            color: #9bc0d7;
            line-height: 1.4;
        }

        .status {
            border: 1px solid rgba(128, 220, 255, 0.28);
            background: rgba(3, 14, 24, 0.84);
            padding: 10px 12px;
            min-height: 44px;
            font-size: 12px;
            color: #7ecfff;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
        }

        .status.err { color: #ff8f9f; border-color: rgba(255, 116, 145, 0.44); }
        .status.ok { color: #8cffca; border-color: rgba(122, 255, 196, 0.48); }
        .status.warn { color: #ffd58f; border-color: rgba(255, 210, 132, 0.45); }

        .preset-panel {
            border: 1px solid rgba(129, 220, 255, 0.24);
            background: rgba(2, 11, 23, 0.76);
            padding: 10px 12px;
            overflow: auto;
        }

        .preset-panel h4 {
            margin: 0 0 9px;
            font-size: 11px;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8fd5f7;
        }

        .preset-list {
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .preset-row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            border: 1px solid rgba(126, 220, 255, 0.2);
            background: rgba(6, 17, 32, 0.76);
            padding: 7px 8px;
            font-size: 11px;
            line-height: 1.3;
        }

        .preset-row .slot {
            color: #8bb2c9;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }

        .preset-row .item {
            color: #ddf6ff;
            text-align: right;
            word-break: break-word;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        button {
            border: 1px solid rgba(117, 220, 255, 0.56);
            background:
                linear-gradient(150deg, rgba(0, 192, 255, 0.42), rgba(0, 192, 255, 0.18) 60%, rgba(75, 255, 228, 0.22)),
                linear-gradient(90deg, rgba(255, 255, 255, 0.14), transparent 36%);
            color: #effbff;
            padding: 14px 26px;
            min-height: 46px;
            font-family: inherit;
            font-size: 12px;
            letter-spacing: 2.4px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease, opacity 180ms ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(110deg, transparent 0%, rgba(255, 255, 255, 0.45) 50%, transparent 63%);
            transform: translateX(-135%);
            transition: transform 450ms ease;
        }

        button:hover::before { transform: translateX(130%); }
        button:hover {
            transform: translateY(-1px);
            border-color: rgba(131, 230, 255, 0.9);
            box-shadow: 0 12px 28px rgba(0, 197, 255, 0.3);
        }

        button:disabled {
            opacity: 0.42;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        button:disabled::before { display: none; }

        .btn-danger {
            border-color: rgba(255, 127, 151, 0.62);
            background:
                linear-gradient(145deg, rgba(255, 70, 105, 0.36), rgba(182, 39, 68, 0.24)),
                linear-gradient(90deg, rgba(255, 255, 255, 0.14), transparent 40%);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(1, 7, 15, 0.56);
            backdrop-filter: blur(3px);
            z-index: 10;
        }

        .modal-backdrop.open { display: flex; }

        .modal {
            width: min(92vw, 470px);
            border: 1px solid var(--line);
            background:
                linear-gradient(152deg, rgba(7, 20, 36, 0.98), rgba(5, 11, 23, 0.94)),
                linear-gradient(92deg, rgba(0, 198, 255, 0.08), transparent 45%);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.58), 0 0 36px rgba(0, 197, 255, 0.14);
            position: relative;
            overflow: hidden;
            padding: 16px;
            animation: popIn 220ms ease-out;
        }

        .modal::after {
            content: "";
            position: absolute;
            inset: 10px;
            border: 1px solid var(--line-soft);
            pointer-events: none;
        }

        .modal h3 {
            margin: 0 0 12px;
            font-size: 13px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #dff8ff;
            position: relative;
            z-index: 1;
        }

        .field {
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .field label {
            display: block;
            margin-bottom: 5px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.3px;
            color: #90b7d0;
        }

        .field input,
        .field select {
            width: 100%;
            border: 1px solid rgba(130, 222, 255, 0.32);
            background: rgba(2, 12, 24, 0.84);
            color: #eff9ff;
            min-height: 39px;
            padding: 8px 10px;
            outline: none;
            font-family: inherit;
            font-size: 13px;
        }

        .field input:focus,
        .field select:focus {
            border-color: rgba(129, 226, 255, 0.76);
            box-shadow: 0 0 0 1px rgba(129, 226, 255, 0.24), 0 0 10px rgba(0, 199, 255, 0.12);
        }

        .modal-note {
            font-size: 11px;
            color: #a6cbe2;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            line-height: 1.4;
        }

        .modal-note b { color: #e8fbff; }

        .modal-actions {
            position: relative;
            z-index: 1;
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            border-color: rgba(123, 165, 190, 0.45);
            background: linear-gradient(145deg, rgba(50, 68, 83, 0.78), rgba(33, 44, 58, 0.84));
        }

        .mini-hint {
            margin-top: 6px;
            font-size: 10px;
            color: #88acc4;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        @keyframes starsDrift {
            from { transform: translate3d(0, 0, 0); }
            to { transform: translate3d(-160px, -220px, 0); }
        }

        @keyframes gridDrift {
            from { transform: perspective(1000px) rotateX(67deg) translateY(24%) translateX(0); }
            to { transform: perspective(1000px) rotateX(67deg) translateY(24%) translateX(-110px); }
        }

        @keyframes flowPerspective {
            from {
                transform: perspective(1400px) rotateX(73deg) translateY(34%) scale(1.18);
                filter: blur(18px) saturate(1.04);
            }
            to {
                transform: perspective(1400px) rotateX(73deg) translateY(41%) scale(1.28);
                filter: blur(24px) saturate(1.12);
            }
        }

        @keyframes flowSweep {
            0%, 100% { transform: translateX(-5%) skewX(-8deg); }
            50% { transform: translateX(6%) skewX(7deg); }
        }

        @keyframes sweep {
            0%, 74% { transform: translateX(-120%); }
            100% { transform: translateX(125%); }
        }

        @keyframes riseIn {
            from { opacity: 0; transform: translateY(12px) scale(0.992); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(8px) scale(0.985); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes pulseDot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.22); opacity: 0.78; }
        }

        @media (max-width: 1060px) {
            .shell {
                width: min(97vw, 980px);
                height: min(94vh, 900px);
            }

            .layout {
                grid-template-columns: 1fr;
                grid-template-rows: minmax(260px, 1fr) minmax(240px, 0.95fr);
            }

            .actions {
                justify-content: stretch;
            }

            .actions button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="flow-depth" aria-hidden="true"></div>

    <div class="shell">
        <header class="topbar">
            <div class="brand">
                <div class="brand-mark" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 15 12 4l8 11"></path>
                        <path d="M7 13h10"></path>
                        <path d="M9 17h6"></path>
                    </svg>
                </div>
                <div>
                    <div class="brand-title">OpenGunZ</div>
                    <div class="brand-sub">Selecao de Operador NDG</div>
                </div>
            </div>
            <div class="account-status" id="account-status"><i></i><span>Estado: Conectado</span></div>
        </header>

        <main class="layout">
            <section class="panel">
                <div class="panel-head">
                    <span>Slots de Personagem</span>
                    <span id="slot-count" class="slot-count">0/4</span>
                </div>
                <div class="char-list" id="slots"></div>
            </section>

            <section class="panel">
                <div class="info-wrap">
                    <div class="info-head">
                        <span>Criacao e Validacao</span>
                        <span id="active-name">Sem selecao</span>
                    </div>
                    <div class="info-body">
                        <div class="note">Preview em tempo real com <b>sexo/rosto/cabelo</b>. Presets exibidos somente quando o catalogo local comprova todos os itens.</div>
                        <div id="status" class="status">Selecione um personagem ou clique em um slot vazio para criar.</div>
                        <div class="preset-panel">
                            <h4>Loadout do Preset</h4>
                            <div id="preset-detail" class="preset-list"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="actions">
            <button id="btn-delete" class="btn-danger" onclick="openDeleteModal()" style="display:none;">Deletar Personagem</button>
            <button id="btn-enter" onclick="handleSelectCharacter()" disabled>Acessar Area de Combate</button>
        </footer>
    </div>

    <div id="create-modal-backdrop" class="modal-backdrop" onclick="if(event.target===this) closeCreateModal()">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Criar personagem">
            <h3>Criar Personagem</h3>

            <div class="field">
                <label for="char-name">Nome</label>
                <input id="char-name" maxlength="16" placeholder="Digite o nome" />
            </div>

            <div class="field">
                <label for="char-sex">Sexo</label>
                <select id="char-sex"></select>
            </div>

            <div class="field">
                <label for="char-face">Rosto</label>
                <select id="char-face"></select>
            </div>

            <div class="field">
                <label for="char-hair">Cabelo</label>
                <select id="char-hair"></select>
            </div>

            <div class="field">
                <label for="char-preset">Preset Inicial</label>
                <select id="char-preset"></select>
                <div class="mini-hint" id="preset-quick-summary">-</div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeCreateModal()">Cancelar</button>
                <button id="btn-create-confirm" onclick="handleCreateCharacter()">Criar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal-backdrop" class="modal-backdrop" onclick="if(event.target===this) closeDeleteModal()">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Deletar personagem">
            <h3>Confirmar Exclusao</h3>
            <div class="modal-note">Digite o nome do personagem para confirmar:</div>
            <div class="modal-note"><b id="delete-char-name">-</b></div>
            <div class="field">
                <label for="delete-confirm-input">Confirmacao</label>
                <input id="delete-confirm-input" maxlength="16" placeholder="Digite o nome exato" />
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button id="btn-delete-confirm" class="btn-danger" onclick="handleDeleteCharacter()">Deletar</button>
            </div>
        </div>
    </div>

    <script>
        const PROVEN_PROFILE = {
            maxNameLength: 16,
            slotsPerAccount: 4,
            sexValues: [0, 1],
            faceValues: [0, 1, 2, 3],
            hairValues: [0, 1, 2, 3, 4],
            costumeValues: [0, 1, 2, 3, 4, 5]
        };

        const PRESET_CATALOG = [
            {
                id: 0,
                name: 'Assalto Balanceado',
                equipment: { melee: 1, primary: 5001, secondary: 4001, item1: 30301, item2: 0, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            },
            {
                id: 1,
                name: 'Close Range',
                equipment: { melee: 2, primary: 5002, secondary: 0, item1: 30301, item2: 0, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            },
            {
                id: 2,
                name: 'Tatico',
                equipment: { melee: 1, primary: 4005, secondary: 5001, item1: 30401, item2: 0, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            },
            {
                id: 3,
                name: 'Precisao',
                equipment: { melee: 2, primary: 4001, secondary: 0, item1: 30401, item2: 0, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            },
            {
                id: 4,
                name: 'Utilitario',
                equipment: { melee: 2, primary: 4002, secondary: 0, item1: 30401, item2: 30001, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            },
            {
                id: 5,
                name: 'Suporte',
                equipment: { melee: 1, primary: 4006, secondary: 0, item1: 30101, item2: 30001, chest: 21001, hands: 0, legs: 23001, feet: 0 }
            }
        ];

        const ITEM_CATALOG = {
            1: { name: 'Dagger01', modelId: 'weapon/dagger01' },
            2: { name: 'Katana01', modelId: 'weapon/katana01' },
            4001: { name: 'Pistol01', modelId: 'weapon/pistol01' },
            4002: { name: 'Pistol01x2', modelId: 'weapon/pistol01x2' },
            4005: { name: 'Pistol07', modelId: 'weapon/pistol07' },
            4006: { name: 'Pistol07x2', modelId: 'weapon/pistol07x2' },
            5001: { name: 'SMG01', modelId: 'weapon/smg01' },
            5002: { name: 'SMG01x2', modelId: 'weapon/smg01x2' },
            30001: { name: 'MediKit', modelId: 'weapon/medikit' },
            30101: { name: 'RepairKit', modelId: 'weapon/repairkit' },
            30301: { name: 'Grenade01', modelId: 'weapon/grenade01' },
            30401: { name: 'Smoke01', modelId: 'weapon/smoke01' },
            21001: { name: 'Chest M', modelId: 'parts/eq_chest_12' },
            21501: { name: 'Chest W', modelId: 'parts/eq_chest_05' },
            23001: { name: 'Legs M', modelId: 'parts/eq_legs_01' },
            23501: { name: 'Legs W', modelId: 'parts/eq_legs_g002' }
        };

        const SLOT_ORDER = ['melee', 'primary', 'secondary', 'item1', 'item2', 'chest', 'hands', 'legs', 'feet'];
        const SLOT_LABELS = {
            melee: 'Melee',
            primary: 'Primaria',
            secondary: 'Secundaria',
            item1: 'Item 1',
            item2: 'Item 2',
            chest: 'Peitoral',
            hands: 'Luvas',
            legs: 'Calca',
            feet: 'Botas'
        };

        function uniqueNumeric(values) {
            const out = [];
            const seen = new Set();
            (Array.isArray(values) ? values : []).forEach((raw) => {
                const n = Number(raw);
                if (!Number.isFinite(n)) return;
                if (seen.has(n)) return;
                seen.add(n);
                out.push(n);
            });
            return out;
        }

        function mergeWithProven(values, provenValues) {
            const merged = uniqueNumeric([...(Array.isArray(values) ? values : []), ...provenValues]);
            return merged.filter((v) => provenValues.includes(v));
        }

        function firstOf(arr, fallback = 0) {
            return Array.isArray(arr) && arr.length > 0 ? Number(arr[0]) : Number(fallback);
        }

        function numOr(value, fallback = 0) {
            const n = Number(value);
            return Number.isFinite(n) ? n : Number(fallback);
        }

        function normalizeEquipment(eq) {
            const src = eq || {};
            const out = {};
            SLOT_ORDER.forEach((slot) => {
                out[slot] = numOr(src[slot], 0);
            });
            return out;
        }

        function getPresetById(id) {
            return PRESET_CATALOG.find((p) => p.id === Number(id)) || null;
        }

        function getItemMeta(itemId) {
            return ITEM_CATALOG[itemId] || null;
        }

        function presetHasMappedItems(preset) {
            if (!preset || !preset.equipment) return false;
            const ids = Object.values(preset.equipment).filter((v) => Number(v) > 0).map(Number);
            return ids.every((id) => !!ITEM_CATALOG[id]);
        }

        function presetSummary(preset) {
            if (!preset) return '-';
            const eq = normalizeEquipment(preset.equipment);
            const parts = [];
            if (eq.primary > 0) {
                const meta = getItemMeta(eq.primary);
                parts.push(meta ? meta.name : `ID ${eq.primary}`);
            }
            if (eq.secondary > 0) {
                const meta = getItemMeta(eq.secondary);
                parts.push(meta ? meta.name : `ID ${eq.secondary}`);
            }
            if (eq.item1 > 0) {
                const meta = getItemMeta(eq.item1);
                parts.push(meta ? meta.name : `ID ${eq.item1}`);
            }
            return parts.join(' / ') || 'Loadout inicial';
        }

        let characters = [];
        let selectedId = null;
        let selectedName = '';
        let creatingInSlot = -1;
        let isCreatingMode = false;
        let cachedActiveCharId = null;
        let characterCreateConfig = { ...PROVEN_PROFILE };

        function setStatus(text, tone = 'ok') {
            const el = document.getElementById('status');
            el.className = 'status';
            if (tone === 'err') el.classList.add('err');
            if (tone === 'warn') el.classList.add('warn');
            if (tone === 'ok') el.classList.add('ok');
            el.textContent = String(text || '').toUpperCase();
        }

        function normalizeCharCreate(data) {
            const cfg = data && data.characterCreate ? data.characterCreate : {};

            const sexValues = mergeWithProven(cfg.sexValues, PROVEN_PROFILE.sexValues);
            const faceValues = mergeWithProven(cfg.faceValues, PROVEN_PROFILE.faceValues);
            const hairValues = mergeWithProven(cfg.hairValues, PROVEN_PROFILE.hairValues);
            const costumeValues = mergeWithProven(cfg.costumeValues, PROVEN_PROFILE.costumeValues);

            const maxNameLengthRaw = numOr(cfg.maxNameLength, PROVEN_PROFILE.maxNameLength);
            const maxNameLength = Math.max(3, Math.min(PROVEN_PROFILE.maxNameLength, maxNameLengthRaw));
            const slotsRaw = numOr(cfg.slotsPerAccount, PROVEN_PROFILE.slotsPerAccount);
            const slotsPerAccount = Math.max(1, Math.min(PROVEN_PROFILE.slotsPerAccount, slotsRaw));

            return {
                maxNameLength,
                slotsPerAccount,
                sexValues: sexValues.length ? sexValues : [...PROVEN_PROFILE.sexValues],
                faceValues: faceValues.length ? faceValues : [...PROVEN_PROFILE.faceValues],
                hairValues: hairValues.length ? hairValues : [...PROVEN_PROFILE.hairValues],
                costumeValues: costumeValues.length ? costumeValues : [...PROVEN_PROFILE.costumeValues]
            };
        }

        function fillSelect(selectId, values, labelResolver) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '';
            values.forEach((value, index) => {
                const opt = document.createElement('option');
                opt.value = String(value);
                opt.textContent = labelResolver(value, index);
                sel.appendChild(opt);
            });
            if (values.length > 0) sel.value = String(values[0]);
        }

        function getAvailablePresetIds(valuesFromConfig) {
            const configValues = uniqueNumeric(valuesFromConfig);
            const mappedPresetIds = PRESET_CATALOG.filter(presetHasMappedItems).map((p) => p.id);
            const intersect = configValues.filter((id) => mappedPresetIds.includes(id));
            if (intersect.length > 0) return intersect;
            return mappedPresetIds;
        }

        function applyCharacterCreateConfig(config) {
            const safe = normalizeCharCreate({ characterCreate: config });
            const availablePresets = getAvailablePresetIds(safe.costumeValues);

            characterCreateConfig = {
                ...safe,
                costumeValues: availablePresets
            };

            document.getElementById('char-name').maxLength = characterCreateConfig.maxNameLength;

            fillSelect('char-sex', characterCreateConfig.sexValues, (value) => Number(value) === 1 ? 'Feminino' : 'Masculino');
            fillSelect('char-face', characterCreateConfig.faceValues, (_value, index) => `Rosto ${index + 1}`);
            fillSelect('char-hair', characterCreateConfig.hairValues, (_value, index) => `Cabelo ${index + 1}`);
            fillSelect('char-preset', characterCreateConfig.costumeValues, (value) => {
                const preset = getPresetById(value);
                return preset ? `${preset.name} [#${preset.id}]` : `Preset ${Number(value) + 1}`;
            });

            const hidden = uniqueNumeric(safe.costumeValues).filter((id) => !availablePresets.includes(id));
            if (hidden.length > 0) {
                setStatus(`Presets ocultados por falta de mapeamento local: ${hidden.join(', ')}`, 'warn');
            }

            renderPresetDetail(firstOf(characterCreateConfig.costumeValues, 0));
        }

        function findCharacterById(id) {
            return characters.find((c) => c.id === id) || null;
        }

        function inferPresetFromCharacter(charData) {
            if (!charData || !charData.equipment) return firstOf(characterCreateConfig.costumeValues, 0);
            const currentEq = normalizeEquipment(charData.equipment);

            for (const preset of PRESET_CATALOG) {
                const presetEq = normalizeEquipment(preset.equipment);
                const fullMatch = SLOT_ORDER.every((slot) => currentEq[slot] === presetEq[slot]);
                if (fullMatch && characterCreateConfig.costumeValues.includes(preset.id)) {
                    return preset.id;
                }
            }

            return firstOf(characterCreateConfig.costumeValues, 0);
        }

        function renderPresetDetail(presetId) {
            const panel = document.getElementById('preset-detail');
            const quick = document.getElementById('preset-quick-summary');
            panel.innerHTML = '';

            const preset = getPresetById(presetId);
            if (!preset) {
                quick.textContent = 'Preset indisponivel.';
                const row = document.createElement('div');
                row.className = 'preset-row';
                row.innerHTML = '<span class="slot">Info</span><span class="item">Preset nao encontrado.</span>';
                panel.appendChild(row);
                return;
            }

            quick.textContent = presetSummary(preset);
            const eq = normalizeEquipment(preset.equipment);
            SLOT_ORDER.forEach((slot) => {
                const itemId = eq[slot];
                const row = document.createElement('div');
                row.className = 'preset-row';
                const label = SLOT_LABELS[slot] || slot;
                if (itemId > 0) {
                    const meta = getItemMeta(itemId);
                    const text = meta ? `${meta.name} (ID ${itemId})` : `ID ${itemId}`;
                    row.innerHTML = `<span class="slot">${label}</span><span class="item">${text}</span>`;
                } else {
                    row.innerHTML = `<span class="slot">${label}</span><span class="item">-</span>`;
                }
                panel.appendChild(row);
            });
        }

        function updateActionButtons() {
            const enterBtn = document.getElementById('btn-enter');
            const deleteBtn = document.getElementById('btn-delete');
            const hasSelection = !!selectedId;

            enterBtn.disabled = !hasSelection || isCreatingMode;
            deleteBtn.style.display = hasSelection && !isCreatingMode ? 'inline-flex' : 'none';
            deleteBtn.disabled = !hasSelection || isCreatingMode;

            const activeLabel = hasSelection ? selectedName : 'Sem selecao';
            document.getElementById('active-name').textContent = activeLabel;
        }

        function renderSlots() {
            const container = document.getElementById('slots');
            container.innerHTML = '';

            const maxSlots = Number(characterCreateConfig.slotsPerAccount || PROVEN_PROFILE.slotsPerAccount);
            const slotCount = Math.min(PROVEN_PROFILE.slotsPerAccount, Math.max(1, maxSlots));
            document.getElementById('slot-count').textContent = `${characters.length}/${slotCount}`;

            for (let i = 0; i < slotCount; i++) {
                const char = characters[i];
                const slot = document.createElement('div');
                slot.className = 'char-slot' + (char && selectedId === char.id ? ' active' : '');

                if (char) {
                    const sexLabel = Number(char.sex) === 1 ? 'FEM' : 'MASC';
                    slot.innerHTML = `
                        <div class="slot-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"></circle><path d="M4 20a8 8 0 0 1 16 0"></path></svg>
                        </div>
                        <div class="slot-main">
                            <div class="slot-name">${String(char.name || '').toUpperCase()}</div>
                            <div class="slot-meta">LV ${numOr(char.level, 1)} | ${sexLabel} | FACE ${numOr(char.face, 0) + 1} | HAIR ${numOr(char.hair, 0) + 1}</div>
                        </div>
                    `;

                    slot.onclick = () => {
                        selectedId = char.id;
                        selectedName = char.name || '';
                        updateActionButtons();
                        renderSlots();
                        applyPreviewForCharacter(char);
                        const inferredPreset = inferPresetFromCharacter(char);
                        renderPresetDetail(inferredPreset);
                        setStatus(`Selecionado: ${selectedName}.`, 'ok');
                    };
                } else {
                    slot.innerHTML = `
                        <div class="slot-icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                        </div>
                        <div class="slot-main">
                            <div class="slot-name">Slot Vazio</div>
                            <div class="slot-empty">Clique para criar personagem</div>
                        </div>
                    `;
                    slot.onclick = () => openCreateModal(i);
                }

                container.appendChild(slot);
            }

            updateActionButtons();
        }

        function openCreateModal(slotIndex) {
            creatingInSlot = slotIndex;
            isCreatingMode = true;

            const modal = document.getElementById('create-modal-backdrop');
            modal.classList.add('open');

            const nameInput = document.getElementById('char-name');
            nameInput.value = '';

            document.getElementById('char-sex').value = String(firstOf(characterCreateConfig.sexValues, 0));
            document.getElementById('char-face').value = String(firstOf(characterCreateConfig.faceValues, 0));
            document.getElementById('char-hair').value = String(firstOf(characterCreateConfig.hairValues, 0));
            document.getElementById('char-preset').value = String(firstOf(characterCreateConfig.costumeValues, 0));

            renderPresetDetail(parseInt(document.getElementById('char-preset').value || '0', 10));
            updateActionButtons();
            setStatus(`Modo de criacao ativo no slot ${slotIndex + 1}.`, 'ok');
            if (window.set_preview_visible) set_preview_visible(true);
            applyPreviewFromForm();
            setTimeout(() => nameInput.focus(), 0);
        }

        function closeCreateModal() {
            document.getElementById('create-modal-backdrop').classList.remove('open');
            creatingInSlot = -1;
            isCreatingMode = false;
            updateActionButtons();

            if (!selectedId && window.set_preview_visible) {
                set_preview_visible(false);
            }
        }

        function openDeleteModal() {
            if (isCreatingMode) {
                setStatus('Finalize ou cancele o modo de criacao primeiro.', 'warn');
                return;
            }
            if (!selectedId) {
                setStatus('Selecione um personagem antes de deletar.', 'warn');
                return;
            }

            const current = findCharacterById(selectedId);
            if (!current) {
                setStatus('Personagem selecionado nao encontrado.', 'err');
                return;
            }

            selectedName = current.name || '';
            document.getElementById('delete-char-name').textContent = selectedName;
            const input = document.getElementById('delete-confirm-input');
            input.value = '';
            document.getElementById('delete-modal-backdrop').classList.add('open');
            setStatus('Confirme a exclusao digitando o nome do personagem.', 'warn');
            setTimeout(() => input.focus(), 0);
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal-backdrop').classList.remove('open');
            document.getElementById('delete-confirm-input').value = '';
            document.getElementById('btn-delete-confirm').disabled = false;
        }

        function handleCreateCharacter() {
            const name = String(document.getElementById('char-name').value || '').trim();
            const sex = parseInt(document.getElementById('char-sex').value || '0', 10);
            const face = parseInt(document.getElementById('char-face').value || '0', 10);
            const hair = parseInt(document.getElementById('char-hair').value || '0', 10);
            const preset = parseInt(document.getElementById('char-preset').value || '0', 10);

            if (!name) {
                setStatus('Informe um nome para o personagem.', 'warn');
                return;
            }

            if (!window.create_character) {
                setStatus('Bridge create_character indisponivel.', 'err');
                return;
            }

            if (!characterCreateConfig.sexValues.includes(sex) ||
                !characterCreateConfig.faceValues.includes(face) ||
                !characterCreateConfig.hairValues.includes(hair) ||
                !characterCreateConfig.costumeValues.includes(preset)) {
                setStatus('Parametros de criacao fora do perfil comprovado.', 'err');
                return;
            }

            const btn = document.getElementById('btn-create-confirm');
            btn.disabled = true;
            setStatus('Criando personagem...', 'ok');
            create_character(name, sex, face, preset, hair);
        }

        function handleDeleteCharacter() {
            if (!selectedId || !selectedName) {
                setStatus('Selecione um personagem antes de deletar.', 'warn');
                return;
            }
            if (!window.delete_character) {
                setStatus('Bridge delete_character indisponivel.', 'err');
                return;
            }

            const typed = String(document.getElementById('delete-confirm-input').value || '').trim();
            if (typed !== selectedName) {
                setStatus('Nome de confirmacao incorreto.', 'err');
                return;
            }

            const btn = document.getElementById('btn-delete-confirm');
            btn.disabled = true;
            setStatus('Deletando personagem...', 'warn');
            delete_character(selectedId);
        }

        function applyPreviewForCharacter(charData) {
            if (!charData || !window.set_character_preview) return false;

            const sex = numOr(charData.sex, firstOf(characterCreateConfig.sexValues, 0));
            const face = numOr(charData.face, firstOf(characterCreateConfig.faceValues, 0));
            const hair = numOr(charData.hair, firstOf(characterCreateConfig.hairValues, 0));
            const preset = inferPresetFromCharacter(charData);

            if (window.set_preview_visible) set_preview_visible(true);
            const ok = !!set_character_preview(sex, face, preset, hair);
            if (!ok) {
                setStatus('Preview indisponivel: pacote ou texturas invalidas.', 'err');
            }
            return ok;
        }

        function applyPreviewFromForm() {
            if (!window.set_character_preview) return false;

            const sex = parseInt(document.getElementById('char-sex').value || '0', 10);
            const face = parseInt(document.getElementById('char-face').value || '0', 10);
            const hair = parseInt(document.getElementById('char-hair').value || '0', 10);
            const preset = parseInt(document.getElementById('char-preset').value || '0', 10);

            renderPresetDetail(preset);

            const ok = !!set_character_preview(sex, face, preset, hair);
            if (!ok) {
                setStatus('Preview indisponivel: pacote ou texturas invalidas.', 'err');
            }
            return ok;
        }

        function handleSelectCharacter() {
            if (isCreatingMode) {
                setStatus('Finalize ou cancele o modo de criacao primeiro.', 'warn');
                return;
            }
            if (!selectedId) {
                setStatus('Selecione um personagem antes de acessar.', 'warn');
                return;
            }
            if (!window.select_character) {
                setStatus('Bridge select_character indisponivel.', 'err');
                return;
            }

            setStatus('Selecionando personagem...', 'ok');
            select_character(selectedId);
        }

        window.onload = () => {
            applyCharacterCreateConfig(characterCreateConfig);
            renderSlots();
            if (window.fetch_bootstrap_v2) fetch_bootstrap_v2();
            if (window.list_characters) list_characters();
        };

        document.addEventListener('keydown', (ev) => {
            const createOpen = document.getElementById('create-modal-backdrop').classList.contains('open');
            const deleteOpen = document.getElementById('delete-modal-backdrop').classList.contains('open');

            if (createOpen) {
                if (ev.key === 'Escape') closeCreateModal();
                else if (ev.key === 'Enter') handleCreateCharacter();
                return;
            }

            if (deleteOpen) {
                if (ev.key === 'Escape') closeDeleteModal();
                else if (ev.key === 'Enter') handleDeleteCharacter();
                return;
            }

            if (ev.key === 'Enter') handleSelectCharacter();
        });

        document.getElementById('char-sex').addEventListener('change', applyPreviewFromForm);
        document.getElementById('char-face').addEventListener('change', applyPreviewFromForm);
        document.getElementById('char-hair').addEventListener('change', applyPreviewFromForm);
        document.getElementById('char-preset').addEventListener('change', applyPreviewFromForm);

        window.onBootstrapV2 = (data) => {
            if (!data || data.ok === false) {
                const reason = data && (data.reason || data.message) ? (data.reason || data.message) : 'bootstrap indisponivel';
                setStatus(`Bootstrap v2 falhou: ${reason}`, 'warn');
                return;
            }

            const cfg = normalizeCharCreate(data);
            applyCharacterCreateConfig(cfg);
            setStatus('Bootstrap v2 carregado com perfil comprovado.', 'ok');
            if (isCreatingMode) applyPreviewFromForm();
        };

        window.onRtProtocolError = (err) => {
            const code = err && err.code ? String(err.code) : 'RT_PROTOCOL_ERROR';
            const detail = err && (err.detail || err.message) ? String(err.detail || err.message) : 'erro desconhecido';
            setStatus(`${code}: ${detail}`, 'err');
        };

        window.onCharacterList = (data) => {
            characters = Array.isArray(data && data.characters) ? data.characters.slice().sort((a, b) => numOr(a.charIndex, 0) - numOr(b.charIndex, 0)) : [];
            cachedActiveCharId = data && data.activeCharId ? String(data.activeCharId) : null;

            if (selectedId && !findCharacterById(selectedId)) {
                selectedId = null;
                selectedName = '';
            }

            if (!isCreatingMode && !selectedId && cachedActiveCharId && findCharacterById(cachedActiveCharId)) {
                selectedId = cachedActiveCharId;
                const active = findCharacterById(selectedId);
                selectedName = active ? (active.name || '') : '';
            }

            if (!isCreatingMode && !selectedId && characters.length > 0) {
                selectedId = characters[0].id;
                selectedName = characters[0].name || '';
            }

            renderSlots();

            if (!isCreatingMode) {
                const selected = selectedId ? findCharacterById(selectedId) : null;
                if (selected) {
                    applyPreviewForCharacter(selected);
                    renderPresetDetail(inferPresetFromCharacter(selected));
                } else {
                    renderPresetDetail(firstOf(characterCreateConfig.costumeValues, 0));
                    if (window.set_preview_visible) set_preview_visible(false);
                }
            }

            const hasFreeSlot = characters.length < characterCreateConfig.slotsPerAccount;
            if (!hasFreeSlot) {
                setStatus('Todos os slots estao ocupados.', 'warn');
            }
        };

        window.onCreateCharacterResult = (result) => {
            const btn = document.getElementById('btn-create-confirm');
            btn.disabled = false;

            if (result && result.success) {
                closeCreateModal();
                setStatus('Personagem criado com sucesso.', 'ok');
                if (window.list_characters) list_characters();
            } else {
                const msg = result && result.message ? result.message : 'erro desconhecido';
                setStatus(`Falha ao criar personagem: ${msg}`, 'err');
            }
        };

        window.onDeleteCharacterResult = (result) => {
            const btn = document.getElementById('btn-delete-confirm');
            btn.disabled = false;

            if (result && result.success) {
                closeDeleteModal();
                selectedId = null;
                selectedName = '';
                updateActionButtons();
                setStatus('Personagem deletado com sucesso.', 'ok');
                if (window.list_characters) list_characters();
            } else {
                const msg = result && result.message ? result.message : 'erro desconhecido';
                setStatus(`Falha ao deletar: ${msg}`, 'err');
            }
        };

        window.onSelectCharacterResult = (result) => {
            if (result && result.success) {
                setStatus('Personagem selecionado. Entrando no lobby...', 'ok');
                if (window.enter_lobby) {
                    enter_lobby();
                } else {
                    window.location.href = 'lobby.html';
                }
            } else {
                const msg = result && result.message ? result.message : 'erro desconhecido';
                setStatus(`Falha ao selecionar: ${msg}`, 'err');
            }
        };
    </script>
</body>
</html>
